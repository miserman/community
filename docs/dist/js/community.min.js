!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=require("tslib"),e=t.__importDefault(require("../data_handler/index")),i=require("./defaults"),s=require("./global_view"),a=require("./patterns"),n=require("./storage"),r=require("./subscriptions"),d=t.__importStar(require("./conditionals")),o=t.__importStar(require("./utils")),u=require("./palettes"),l=require("./inputs/select"),h=require("./inputs/number"),p=require("./dataview"),c=require("./page"),f=require("./inputs/virtual"),_=require("./inputs/button"),m=require("./inputs/combobox"),y=require("./inputs/radio"),g=require("./inputs/checkbox"),v=require("./outputs/info"),b=require("./outputs/map"),w=require("./outputs/plotly"),q=require("./inputs/buttongroup"),x=require("./inputs/switch"),E=require("./inputs/text"),O=require("./outputs/datatables"),k=require("./outputs/table"),S=require("./outputs/legend"),M=require("./outputs/text"),T={button:_.InputButton,buttongroup:q.InputButtonGroup,combobox:m.InputCombobox,select:l.InputSelect,number:h.InputNumber,radio:y.InputRadio,switch:x.InputSwitch,checkbox:g.InputCheckbox,text:E.InputText},j={info:v.OutputInfo,map:b.OutputMap,plotly:w.OutputPlotly,datatable:O.OutputDataTable,table:k.OutputTable,legend:S.OutputLegend,text:M.OutputText};exports.default=class{constructor(t){if(this.storage=n.storage,this.patterns=a.patterns,this.palettes=u.palettes,this.conditionals={},this.registered_inputs=new Map,this.registered_outputs=new Map,this.defaults=i.defaults,this.dataviews={},this.inputs={},this.outputs={},this.dependencies={},this.url_options={},this.queue={timeout:0,elements:new Map},this.tree={},this.maps={queue:{},waiting:{},overlay_property_selectors:[]},this.meta={retain_state:!0,lock_after:""},this.state="",this.query="",this.parsed_query={},this.rule_conditions={},t&&(this.spec=t,t.active=this),t.settings||(t.settings={}),"dataLayer"in window||(window.dataLayer=[]),n.storage.copy=n.storage.get(),n.storage.copy)for(const e in t.settings)if(e in n.storage.copy){let i=n.storage.copy[e];"string"==typeof i&&(a.patterns.bool.test(i)?i=!!i||"true"===i:a.patterns.number.test(i)&&(i=parseFloat(i))),t.settings[e]=i}function o(t,e,i){const s=i.length;let a=i[0][t]+e*i[1][t],n=2;for(;n<s;n++)a+=Math.pow(e,n)*i[n][t];return Math.max(0,Math.min(255,a))}Object.keys(u.palettes).forEach((t=>{let e=u.palettes[t];if("continuous-polynomial"===e.type){const i=e.colors,s={name:t,type:"discrete",colors:[]};for(let t=0;t<255;t++){const e=t/255;s.colors.push("rgb("+o(0,e,i)+", "+o(1,e,i)+", "+o(2,e,i)+")")}e=u.palettes[t]=s}e.odd=e.colors.length%2})),this.query=window.location.search.replace("?",""),this.query&&this.query.split("&").forEach((t=>{const e=t.split("=");let i;e[0],e.length<2&&e.push("true"),i=a.patterns.bool.test(e[1])?!!e[1]||"true"===e[1]:e[1].replace(a.patterns.url_spaces," "),this.url_options[e[0]]=i,a.patterns.settings.test(e[0])&&n.storage.set(e[0].replace(a.patterns.settings,""),i)})),("embedded"in this.url_options||"hide_navbar"in this.url_options)&&("hide_logo"in this.url_options||(this.url_options.hide_logo=!0),"hide_title"in this.url_options||(this.url_options.hide_title=!0),"hide_navcontent"in this.url_options||(this.url_options.hide_navcontent=!0),"hide_panels"in this.url_options||(this.url_options.hide_panels=!0),"embedded"in this.url_options&&!("close_menus"in this.url_options)&&(this.url_options.close_menus=!0)),this.init=this.init.bind(this),this.request_queue=this.request_queue.bind(this),this.run_queue=this.run_queue.bind(this),this.global_reset=this.global_reset.bind(this),Object.keys(d).forEach((t=>this.conditionals[t]=d[t].bind(this))),this.spec.dataviews?this.defaults.dataview=Object.keys(this.spec.dataviews)[0]:(this.spec.dataviews={},this.spec.dataviews[this.defaults.dataview]={}),this.maps.overlay_property_selectors||(this.maps.overlay_property_selectors=[]),this.view=new s.GlobalView(this),new c.Page(this),document.querySelectorAll(".auto-input").forEach((t=>{if(t.dataset.autotype in T&&!(t.id in this.inputs)){const e=new T[t.dataset.autotype](t,this);this.registered_inputs.set(e.id,e),this.inputs[e.id]=e}})),this.subs=new r.Subscriptions(this),document.querySelectorAll(".auto-output").forEach((t=>{if(t.dataset.autotype in j&&!(t.id in this.outputs)){const e=new j[t.dataset.autotype](t,this);this.registered_outputs.set(e.id,e),this.outputs[e.id]=e;const i="options"in e?e.options:e.spec;"subto"in i&&("string"==typeof i.subto&&(i.subto=[i.subto]),Array.isArray(i.subto)&&i.subto.forEach((t=>this.subs.add(t,e))))}})),t.variables&&t.variables.length&&t.variables.forEach((t=>{const e=new f.InputVirtual(t,this);this.registered_inputs.set(t.id,e),this.inputs[t.id]=e})),this.defaults.dataset=this.spec.dataviews[i.defaults.dataview].dataset,this.spec.metadata||(this.spec.metadata={datasets:[]});const l=this.spec.metadata.datasets;l&&l.length&&-1===l.indexOf(this.defaults.dataset)&&(1===l.length?this.defaults.dataset=l[0]:(this.registered_inputs.forEach((t=>{if(!this.defaults.dataset){const e=t.default;-1!==l.indexOf(t.dataset)?this.defaults.dataset=t.dataset:"string"==typeof e&&-1!==l.indexOf(e)?this.defaults.dataset=e:"select"===t.type&&"number"==typeof e&&t.options[e]&&-1!==l.indexOf(t.options[e].value)?this.defaults.dataset=t.options[e].value:("select"===t.type||"combobox"===t.type)&&Array.isArray(t.values)&&t.values[t.default]&&-1!==l.indexOf(t.values[t.default])&&(this.defaults.dataset=t.values[t.default])}})),this.defaults.dataset||(this.defaults.dataset=l[l.length-1])),this.defaults.dataset=this.valueOf(this.defaults.dataset),-1===l.indexOf(this.defaults.dataset)&&(this.defaults.dataset=l[0]),this.registered_inputs.forEach((t=>{t.dataset||(t.dataset=this.defaults.dataset)})),this.spec.dataviews[i.defaults.dataview].dataset||(this.spec.dataviews[i.defaults.dataview].dataset=this.defaults.dataset)),t.rules&&t.rules.length&&t.rules.forEach(((t,i)=>{if(t.parsed={},"display"in t.effects){t.parsed.display={e:document.getElementById(t.effects.display)};const e=t.parsed.display.e.querySelector(".auto-input");if(e){const i=this.inputs[e.id];i.rule=t,t.parsed.display.u=i}}if("lock"in t.effects){const e=new Map;document.querySelectorAll("#"+t.effects.lock+" .auto-input").forEach((t=>e.set(t.id,this.inputs[t.id]))),t.parsed.lock=e}t.condition.forEach((s=>{s.type in e.default.checks&&(s.check=function(){return e.default.checks[this.c.type](this.site.valueOf(this.c.id),this.site.valueOf(this.c.value))}.bind({c:s,site:this}),s.id in this.inputs&&(this.add_dependency(s.id,{type:"rule",id:s.id,condition:s,rule:i}),s.id in this.rule_conditions||(this.rule_conditions[s.id]=[]),this.rule_conditions[s.id][i]=t),s.check()?Object.keys(t.effects).forEach((e=>{e in this.inputs&&this.inputs[e].set(this.valueOf(t.effects[e]))})):s.default&&Object.keys(t.effects).forEach((t=>{t in this.inputs&&this.inputs[t].set(this.valueOf(s.default))})))}))}));const h=this.valueOf(this.spec.dataviews[this.defaults.dataview].dataset);this.defaults.dataset="number"==typeof h?l[h]:h,-1===l.indexOf(this.defaults.dataset)&&(this.defaults.dataset=l[0]),this.data=new e.default(this.spec,this.defaults,this.data,{init:this.init,onload:function(){this.data.inited&&clearTimeout(this.data.inited.load_screen),setTimeout(this.drop_load_screen.bind(this),600),delete this.data.onload}.bind(this),data_load:function(){Object.keys(this.dependencies).forEach((t=>this.request_queue(!1,t)))}.bind(this)})}init(){if(this.data.variables){const t=Object.keys(this.data.variables);this.defaults.variable=t[t.length-1]}Object.keys(this.spec.dataviews).forEach((t=>new p.SiteDataView(this,t,this.spec.dataviews[t]))),this.view.init(),this.page.init(),this.query&&(this.parsed_query=this.data.parse_query(this.query),this.parsed_query.variables.conditions.length&&this.parsed_query.variables.conditions.forEach((t=>{this.data.variable_info[t.name]&&this.page.add_filter_condition(t.name,t)}))),this.run_queue(),this.registered_inputs.forEach((e=>t.__awaiter(this,void 0,void 0,(function*(){const t="combobox"===e.type;if(e.optionSource&&"options"in e)if(a.patterns.palette.test(e.optionSource))e.options=[],Object.keys(u.palettes).forEach((t=>e.add(t,u.palettes[t].name))),-1===e.default&&(e.default=i.defaults.palette);else if(a.patterns.datasets.test(e.optionSource))-1===e.default&&(e.default=i.defaults.dataset),e.options=[],this.spec.metadata.datasets.forEach((t=>e.add(t)));else if("option_sets"in e){e.sensitive=!1,a.patterns.properties.test(e.optionSource)&&this.maps.overlay_property_selectors.push(e),e.depends&&this.add_dependency(e.depends,{type:"options",id:e.id}),e.dataset in this.inputs&&this.add_dependency(e.dataset,{type:"options",id:e.id}),e.view&&this.add_dependency(e.view,{type:"options",id:e.id});const t=this.valueOf(e.dataset)||i.defaults.dataset;"string"==typeof t&&(e.dataset||(e.dataset=t),t in this.data.info&&this.conditionals.options(e))}if(t||"select"===e.type){if(Array.isArray(e.values)){e.values={},e.display={};let t=!0;const i="select"===e.type;e.options.forEach((e=>{i&&(e.dataset.value=e.value),t&&(t=e.dataset.value===e.innerText)})),e.options.forEach(((i,s)=>{e.values[i.dataset.value]=s,t&&(i.innerText=this.data.format_label(i.dataset.value)),e.display[i.innerText]=s})),e.default in e.values||e.default in this.inputs||(e.default=+e.default,isNaN(e.default)&&(e.default=-1),-1!==e.default&&e.default<e.options.length?e.default=e.options[e.default].dataset.value:e.default=-1),e.source="",e.id in this.url_options?e.set(this.url_options[e.id]):e.reset()}e.subset=e.e.dataset.subset||"all",e.selection_subset=e.e.dataset.selectionSubset||e.subset,e.type in this.spec&&e.id in this.spec[e.type]&&(e.settings=this.spec[e.type][e.id],e.settings.filters&&Object.keys(e.settings.filters).forEach((t=>{this.add_dependency(e.settings.filters[t],{type:"filter",id:e.id})})))}else if("number"===e.type&&(e.min=e.e.getAttribute("min"),e.min_ref=parseFloat(e.min),e.min_indicator=e.e.parentElement.parentElement.querySelector(".indicator-min"),e.min_indicator&&e.min_indicator.addEventListener("click",function(){this.set(this.parsed.min)}.bind(e)),e.max=e.e.getAttribute("max"),e.max_ref=parseFloat(e.max),e.max_indicator=e.e.parentElement.parentElement.querySelector(".indicator-max"),e.max_indicator&&e.max_indicator.addEventListener("click",function(){this.set(this.parsed.max)}.bind(e)),e.ref=isNaN(e.min_ref)||isNaN(e.max_ref),e.range=[e.min_ref,e.max_ref],e.step=parseFloat(e.e.step)||1,e.parsed={min:void 0,max:void 0},e.depends={},e.default_max="max"===e.default||"last"===e.default,e.default_min="min"===e.default||"first"===e.default,e.view&&this.add_dependency(e.view,{type:"update",id:e.id}),e.max in this.data.variables?e.view&&this.add_dependency(e.view+"_time",{type:"max",id:e.id}):e.max in this.inputs?this.add_dependency(e.max,{type:"max",id:e.id}):e.e.max=e.max,e.min in this.data.variables?e.view&&this.add_dependency(e.view+"_time",{type:"min",id:e.id}):e.min in this.inputs?this.add_dependency(e.min,{type:"min",id:e.id}):e.e.min=e.min,void 0!==e.default&&(a.patterns.number.test(e.default)?e.default=+e.default:e.reset=e.default_max?function(){this.range&&(this.current_default=this.site.valueOf(this.range[1]),this.set(this.current_default))}.bind(e):e.default_max?function(){this.range&&(this.current_default=this.site.valueOf(this.range[0]),this.set(this.current_default))}.bind(e):e.default in this.inputs?function(){this.current_default=this.site.valueOf(this.default),this.set(this.current_default)}.bind(e):function(){}),e.variable)){const t=-1===this.spec.metadata.datasets.indexOf(e.dataset)?i.defaults.dataset:e.dataset;e.variable in this.inputs?this.add_dependency(e.variable,{type:"update",id:e.id}):e.variable in this.data.variables&&(e.min=e.parsed.min=e.range[0]=this.data.variables[e.variable].info[t].min,e.e.min=e.min+"",e.max=e.parsed.max=e.range[1]=this.data.variables[e.variable].info[t].max,e.e.max=e.max+"")}"select"!==e.type&&"number"!==e.type&&"text"!==e.type||e.e.parentElement.lastElementChild&&e.e.parentElement.lastElementChild.classList.contains("select-reset")&&e.e.parentElement.lastElementChild.addEventListener("click",e.reset.bind(e)),a.patterns.settings.test(e.id)&&(e.setting=e.id.replace(a.patterns.settings,""),null==e.default&&e.setting in this.spec.settings&&(e.default=this.spec.settings[e.setting]),this.add_dependency(e.id,{type:"setting",id:e.id})),e.view||(e.view=i.defaults.dataview);const s=this.url_options[e.id]||n.storage.get(e.id.replace(a.patterns.settings,""));"init"in e&&e.init(),s?e.set(s):e.reset()})))),this.registered_outputs.forEach((t=>{"init"in t&&t.init()}))}global_update(){this.meta.retain_state=!1,this.queue.elements.forEach(this.request_queue),this.registered_outputs.forEach((t=>t.update()))}global_reset(){this.meta.retain_state=!1,this.registered_inputs.forEach(((t,e)=>{!t.setting&&t.reset&&(t.reset(),this.request_queue(!1,e))}))}clear_storage(){window.localStorage&&n.storage.perm.removeItem(n.storage.name),window.location.reload()}request_queue(t,e){"boolean"!=typeof t&&(e=t,t=!1),t||-1!==this.queue.timeout&&this.queue.elements.get(e)||(this.queue.elements.set(e,!0),this.queue.timeout>0&&clearTimeout(this.queue.timeout),this.queue.timeout=setTimeout(this.run_queue,20),this.meta.lock_after=e)}run_queue(){this.queue.timeout>0&&clearTimeout(this.queue.timeout),this.queue.timeout=-1,this.queue.elements.forEach(((t,e)=>{if(t){const t=this.refresh_conditions(e);if(t)return e in this.data.data_queue[t]||(this.data.data_queue[t][e]=this.run_queue),!1;this.queue.elements.set(e,!1)}}));let t=this.get_options_url();this.data.inited.first&&t!==this.state&&(this.state=t,Object.keys(this.url_options).forEach((e=>{const i=this.url_options[e];"string"==typeof i&&a.patterns.embed_setting.test(e)&&(t+="&"+e+"="+("navcolor"===e?i.replace(a.patterns.hashes,"%23"):i))})),this.spec.settings.hide_url_parameters||window.history.replaceState(Date.now(),"",t),setTimeout(this.page.resize,50))}refresh_conditions(t){if(t in this.dependencies){const e=this.dependencies[t],i=[],a="view."===t.substring(0,5)?this.view:t in this.dataviews?this.dataviews[t]:this.inputs[t],n=a instanceof p.SiteDataView,r=a instanceof s.GlobalView,d="id"===t.substring(5)?"id_state":"filter_state",u=r?a[d]():a&&a.value()+"",l=r?a.states[d]:a&&a.state;if(a&&(!this.meta.retain_state||l!==u)){if(r)a.states[d]=u;else if(n)a.state=u;else{const t=this.dataviews[a.view],e=u in this.data.loaded?u:a.dataset?this.valueOf(a.dataset):t&&t.get.dataset();if(this.data.info&&e in this.data.loaded&&!this.data.loaded[e])return a.deferred||this.data.retrieve(e,this.data.info[e].site_file),e;a.state=u}e.forEach((t=>{if("rule"===t.type)-1===i.indexOf(t.rule)&&i.push(t.rule);else if("dataview"===t.type)this.dataviews[t.id].update();else if(t.conditional)this.conditionals[t.conditional](t.id in this.dataviews?this.dataviews[t.id]:this.inputs[t.id],a);else if(t.id in this.inputs){const e=this.inputs[t.id];t.type in e&&e[t.type]()}else if(t.id in this.outputs){const e=this.outputs[t.id];t.type in e&&e[t.type]()}})),i.forEach((t=>{let e=!1;const i=this.spec.rules[t],s=i.condition.length;for(let t=0;t<s;t++){const s=i.condition[t];if(e=s.check(),s.any?e:!e)break}Object.keys(i.parsed).forEach((t=>{if(e){if("display"===t)i.parsed[t].e.classList.remove("hidden");else if("lock"===t)i.parsed[t].forEach((t=>{t.e.classList.remove("locked"),o.toggle_input(t,!0)}));else if(t in this.inputs){const e=this.valueOf(i.effects[t]);this.inputs[t].set(e)}}else if("display"===t){const e=i.parsed[t];e.e.classList.contains("hidden")||(e.e.classList.add("hidden"),e.u&&e.u.reset&&e.u.reset(),e.e.querySelectorAll(".auto-input").forEach((t=>{const e=this.inputs[t.id];e&&e.reset&&e.reset()})))}else"lock"===t?i.parsed[t].forEach((t=>{t.e.classList.add("locked"),o.toggle_input(t)})):"default"in i&&t in this.inputs&&this.inputs[t].set(this.valueOf(i.default))}))}))}t===this.meta.lock_after&&(this.meta.retain_state=!0)}}valueOf(t){return"string"==typeof t&&t in this.inputs?this.valueOf(this.inputs[t].value()):t}get_options_url(){let t="";return this.registered_inputs.forEach(((e,i)=>{if(!("virtual"===e.type||a.patterns.settings.test(i)||"range"in e&&e.range[0]===e.range[1])){let s=e.value();("off_default"in e?e.off_default:s!==e.default)&&(Array.isArray(s)&&(s=s.join(",")),""!==s&&null!=s&&"-1"!=s&&(t+=(t?"&":"?")+i+"="+s))}})),this.data&&this.view.filters.size&&(t+=(t?"&":"?")+this.view.filter_state([])),window.location.protocol+"//"+window.location.host+window.location.pathname+t}gtag(...t){this.spec.settings.tracking&&window.dataLayer.push(arguments)}drop_load_screen(){this.data&&this.data.inited&&clearTimeout(+this.data.inited.load_screen),this.page.wrap.style.visibility="visible",this.page.load_screen.style.display="none",this.spec.tutorials&&"tutorial"in this.url_options&&setTimeout(this.page.tutorials.start_tutorial.bind(this.page.tutorials,{target:{dataset:{name:this.url_options.tutorial}}}),0)}add_dependency(t,e){t in this.dependencies||(this.dependencies[t]=[]),e.uid||(e.uid=JSON.stringify(e)),e.type in this.conditionals&&(e.conditional=e.type);const i=this.dependencies[t];for(let t=i.length;t--;)if(e.uid===i[t].uid)return;i.push(e),t in this.tree||(this.tree[t]={_n:{children:0,parents:0},children:{},parents:{}}),e.id in this.tree||(this.tree[e.id]={_n:{children:0,parents:0},children:{},parents:{}}),this.tree[t].children[e.id]=this.tree[e.id],this.tree[t]._n.children++,this.tree[e.id].parents[t]=this.tree[t],this.tree[e.id]._n.parents++,i.sort(((t,e)=>t.id in this.tree&&e.id in this.tree?this.tree[t.id]._n.children-this.tree[e.id]._n.children:-1/0)),this.request_queue(!0,t)}get_color(t,e,s,n,r,d){const o=u.palettes[e];if(isNaN(t)||"continuous-polynomial"===o.type)return this.defaults.missing;const l=this.spec.settings,h="none"!==l.color_scale_center&&!l.color_by_order,p="discrete"===o.type,c="string"===s.type,f=c?0:s.min[n],_=c?s.levels.length-f:s.range[n],m="none"===l.color_scale_center||a.patterns.median.test(l.color_scale_center)?"median":"mean",y=(l.color_by_order?"break_":"norm_")+m,g=l.color_by_order?h?s[y][n]/d:.5:isNaN(s[y][n])?.5:s[y][n],v=p?h&&!l.color_by_order?Math.ceil(o.colors.length/2)-o.odd/2:o.colors.length:1,b=l.color_by_order?(r+.5)/d:_?((c?s.level_ids[t]:t)-f)/_:.5,w=b>(h?g:.5),q=w?"upper_":"lower_",x=q+m+"_range";let E=h?_?((w?b-g:b+g)-s[q+m+"_min"][n])/s[x][n]:1:b;return p||(E=Math.max(0,Math.min(1,E)),w&&(E=1-E),h||(E*=2)),(c?t in s.level_ids:"number"==typeof t)?p?o.colors[Math.max(0,Math.min(o.colors.length-1,Math.floor(h&&w?v+v*E:v*E)))]:"rgb("+(w?o.colors[0][0][0]+E*o.colors[0][1][0]+", "+(o.colors[0][0][1]+E*o.colors[0][1][1])+", "+(o.colors[0][0][2]+E*o.colors[0][1][2]):o.colors[2][0][0]+E*o.colors[2][1][0]+", "+(o.colors[2][0][1]+E*o.colors[2][1][1])+", "+(o.colors[2][0][2]+E*o.colors[2][1][2]))+")":i.defaults.missing}}}));
//# sourceMappingURL=community.min.js.map
