!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const t=require("tslib"),e=require("./checks"),s=require("./exporter"),a=t.__importStar(require("./retrievers")),i=t.__importStar(require("./formatters")),r=t.__importStar(require("./ingesters")),n=t.__importStar(require("./summary")),h=t.__importStar(require("./mappers")),d=t.__importStar(require("./parsers"));class o{constructor(e,a,o,m){this.hooks={},this.defaults={dataview:"default_view",time:"time"},this.settings={},this.metadata={datasets:[]},this.info={},this.sets={},this.dynamic_load=!1,this.all_data_ready=()=>!1,this.data_ready=new Promise((t=>{this.all_data_ready=t})),this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.entity_features={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.retrieve=function(e,s){return t.__awaiter(this,void 0,void 0,(function*(){if(!this.load_requests[e]){this.load_requests[e]=s;const t=new window.XMLHttpRequest;t.onreadystatechange=()=>{if(4===t.readyState){if(200!==t.status)throw new Error("DataHandler.retrieve failed: "+t.responseText);this.ingest_data(JSON.parse(t.responseText),e)}},t.open("GET",s,!0),t.send()}}))},this.format_value=i.value,this.format_label=i.label,this.ingest_data=r.data,this.ingest_map=r.map,this.load_id_maps=r.id_maps,this.init_summary=n.init,this.calculate_summary=n.calculate,this.map_variables=h.variables,this.map_entities=h.entities,this.parse_query=d.query,this.export=s.exporter,this.get_variable=function(e,s){return t.__awaiter(this,void 0,void 0,(function*(){return e in this.variables&&(yield this.calculate_summary(e,s,!0)),this.variables[e]}))},this.get_value=function(t){if(this.variables[t.variable].is_time)return t.entity.time.value;{const e=this.variables[t.variable].code;return e in t.entity.data?Array.isArray(t.entity.data[e])?t.entity.data[e]:[t.entity.data[e]]:[NaN]}},this.defaults=a||{},this.settings=e||{},this.metadata=this.settings.metadata||{datasets:[]},this.sets=o||{},this.hooks=m||{},this.get_value=this.get_value.bind(this),this.dynamic_load="dataviews"in this.settings&&this.settings.settings&&!!this.settings.settings.partial_init,this.settings.view_names=this.dynamic_load?Object.keys(this.settings.dataviews):["default_view"],"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);const _=()=>{if(this.metadata.datasets&&this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.info),this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.sets))),this.metadata.measure_info){const t=d.measure_info(this.metadata.measure_info);this.metadata.datasets.forEach((e=>{t._references&&(this.info[e]._references=t._references);this.info[e].schema.fields.forEach((e=>e.name in t?e.info=t[e.name]:""))}))}this.map_variables(),this.metadata.datasets.length?this.metadata.datasets.forEach((t=>{this.loaded[t]=t in this.sets,this.inited[t]=!1,this.data_processed[t]=new Promise((e=>{this.data_promise[t]=e})),t in this.info&&(this.info[t].site_file=(this.metadata.url?this.metadata.url+"/":"")+this.info[t].name+".json"),this.loaded[t]?this.ingest_data(this.sets[t],t):this.dynamic_load&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&t!==this.defaults.dataset||this.retrieve(t,this.info[t].site_file)})):setTimeout((()=>{this.inited.first=!0,this.hooks.init&&this.hooks.init(),this.hooks.onload&&this.hooks.onload()}),0)};if(this.metadata.package&&!this.metadata.info)if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(t=>{const e=[];t.on("data",(t=>{e.push(t)})),t.on("end",(()=>{this.info={};const t=JSON.parse(e.join(""));t.measure_info&&(this.metadata.measure_info=t.measure_info),t.resources.forEach((t=>this.info[t.name]=t)),_()}))})).end();else{const t=new window.XMLHttpRequest;t.onreadystatechange=()=>{if(4===t.readyState){if(200!==t.status)throw new Error("failed to load datapackage: "+t.responseText);{this.info={};const e=JSON.parse(t.responseText);e.measure_info&&(this.metadata.measure_info=e.measure_info),e.resources.forEach((t=>this.info[t.name]=t)),_()}}},t.open("GET",this.metadata.url+this.metadata.package),t.send()}else this.metadata.info&&(this.info=this.metadata.info),_()}}o.retrievers=a,o.checks=e.value_checks,exports.default=o}));
//# sourceMappingURL=data_handler.min.js.map
